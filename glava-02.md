# Глава 2. Архитектура Asterisk

> _Прежде всего, но не обязательно в таком порядке._
>
> -- Доктор Кто

Asterisk очень отличается от других, более традиционных УАТС тем, что диалплан в Asterisk обрабатывает все входящие каналы по существу одинаково, а не разделяет их на станции, транки, периферийные модули и т.д.

В традиционной АТС существует логическое различие между станциями \(телефонными аппаратами\) и транками \(магистралями - ресурсами, которые подключаются к внешнему миру\). Это ограничение делает творческую маршрутизацию в традиционных УАТС очень сложной или невозможной.

Asterisk, с другой стороны, не имеет внутреннего понятия транков или станций. В Asterisk все, что входит или выходит из системы, проходит через какой-то канал. Существует множество различных типов каналов; однако диалплан Asterisk обрабатывает все каналы аналогичным образом, что означает, например, внутренний пользователь может существовать на конце внешнего транка \(например, сотовый телефон\) и обрабатываться диалпланом точно так же, как если бы пользователь был на внутреннем номере. Если вы не работали с традиционной АТС, то может быть не сразу очевидно насколько это является мощным и освобождающим. Рисунок 2-1 иллюстрирует различия между этими двумя архитектурами.

![Рисунок 2-1. Архитектура Asterisk против УАТС](/pics/pic2-1.png)

_Рисунок 2-1. Архитектура Asterisk против УАТС_

### Модули

Asterisk построен на модулях. Модуль - это загружаемый компонент, который обеспечивает определенную функциональность, такую как драйвер канала (например, _chan_pjsip.so_) или ресурс, который позволяет подключиться к внешней технологии \(например _func_odbc.so_). Модули Asterisk загружаются на основе параметров, определенных в файле _/etc/asterisk/modules.conf_. Мы обсудим использование многих модулей в этой книге, но на этом этапе мы просто хотим представить концепцию модулей и дать вам представление о типах модулей, которые доступны.

На самом деле можно запустить Asterisk вообще без каких-либо модулей, хотя в этом состоянии он ничего не сможет сделать. Это бывает полезно, чтобы понять модульную природу Asterisk для оценки архитектуры.

---

**Примечание**

Вы можете запустить Asterisk без модулей, загружаемых по умолчанию и загружать каждый нужный модуль вручную из консоли, но это не то, что вы хотели бы запустить в продакшен; это было бы полезно только в том случае, если бы вы настраивали производительность системы, в которой хотели убрать все, что не требуется вашим конкретным приложением Asterisk.

---

Типы модулей в Asterisk включают в себя следующие:

* Приложения — рабочие лошадки диалплана, такие как `Dial()`, `Voicemail()`, `Playback()`, `Queue()` и т.д.
* Модули соединения — механизмы, которые соединяют каналы (вызовы) друг с другом
* Модули записи деталей вызовов (CDR)
* Модули регистрации событий канала (CEL)
* Драйверы каналов — различные соединения с системой и из системы; SIP (Session Initiation Protocol) использует канальный драйвер PJSIP
* Трансляторы кодеков — преобразовывают различные кодеки как G729, G711, G722, Speex и так далее
* Интерпретаторы форматов — как указано выше, но относящиеся к файлам, хранящимся в файловой системе
* Функции диалплана — расширенные возможности диалплана
* Модули УАТС
* Модули ресурсов
* Дополнительные модули
* Тестовые модули

Существует официальный список типов статуса поддержки, включенных в `menuselect`.[2](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch02.html%22%20/l%20%22idm46178409833272)

### Приложения

Приложения диалплана используются в _extensions.conf_ для определения различных действий, применимых к вызову. Например, приложение `Dial()` отвечает за создание исходящих соединений с внешними ресурсами и, возможно, является самым важным приложением диалплана. Доступные приложения перечислены в Таблице 2-1.

Таблица 2-1. _Популярные приложения диалплана_

| Имя | Purpose |
| :--- | :--- |
| app\_authenticate | Сравнивает сигналы набора DTMF с указанной строкой \(паролем\) |
| app\_cdr | Записывает данные в CDR |
| app\_chanspy | Позволяет каналу слушать аудио на другом канале |
| app\_confbridge | Обеспечивает конференц-связь |
| app\_dial | Используется для соединения каналов вместе (например, для совершения телефонных звонков) |
| app\_directed\_pickup | Отвечает на звонок, который звонит на другом добавочном номере |
| app\_directory | Представляет список имен из _voicemail.conf_ |
| app\_dumpchan | Выводит переменные канала в интерфейс командной строки Asterisk (CLI)|
| app\_echo | Echos received audio back to source channel (can be helpful in demonstrating latency) |
| app\_exec | Contains `Exec()`, `TryExec()`, and `ExecIf()`: executes a dialplan application conditionally |
| app\_mixmonitor | Records both sides of a call (transmit and receiv\) and mixes them together into a single file |
| app\_originate | Allows dialplan logic to originate a call (as opposed to a call coming in on a channel) |
| app\_page | Creates multiple audio connections to specified devices for public address (paging) |
| app\_parkandannounce | Enables automated announcing of parked calls |
| app\_playback | Plays a file to the channel (does not accept input) |
| app\_playtones | Plays pairs of tones of specified frequencies (DTMF mostly) |
| app\_queue | Provides Automatic Call Distribution (ACD) |
| app\_read | Requests input of digits from callers and assigns input to a variable |
| app\_readexten | Requests input of digits from callers and passes call to a designated extension and context |
| app\_record | Records received audio to a file |
| app\_senddtmf | Transmits DTMF to calling party |
| app\_stack | Provides `GoSub()`, `GoSubIf()`, `Return()`, `StackPop()`, `LOCAL()`, and `LOCAL_PEEK()` |
| app\_stasis | Passes call control to an ARI application—many Asterisk developers use this one application, and from there handle all the rest of their development outside of the Asterisk dialplan |
| app\_system | Executes commands in a Linux shell |
| app\_transfer | Performs a transfer on the current channel |
| app\_voicemail | Provides voicemail |
| app\_while | Includes `While()`, `EndWhile()`, `ExitWhile()`, and `ContinueWhile()`; provides while loop functionality in the dialplan |

### Модули соединений

Модули соединений выполняют фактическое соединение каналов. Эти модули, перечисленные в Таблице 2-2, в настоящее время используются только для (и необходимы) _app\_confbridge_.

Таблица 2-2. _Модули соединений_

| Имя | Описание |
| :--- | :--- |
| bridge\_builtin\_features | Performs bridging when utilizing built-in user features \(such as those found in _features.conf_\). |
| bridge\_multiplexed | Performs complex multiplexing, as would be required in a large conference room \(multiple participants\). Currently only used by app\_confbridge. |
| bridge\_simple | Performs simple channel-to-channel bridging. |
| bridge\_softmix | Performs simple multiplexing, as would be required in a large conference room \(multiple participants\). Currently only used by app\_confbridge. |

В следующих разделах мы рассмотрели список модулей, которые, по нашему мнению, достаточно важны для обсуждения в этой книге. Вы найдете много других модулей в загрузке Asterisk, но многие старые модули либо устарели, либо имеют небольшую поддержку или не поддерживаются, и поэтому не рекомендуются для производства, если у вас нет доступа к разработчикам, которые могут поддерживать их для вас.

### Модули записи деталей вызова \(CDR\)

Модули CDR, перечисленные в Таблице 2-3, предназначены для обеспечения как можно большего числа методов хранения записей сведений о вызовах. CDR можно хранить в файле \(по умолчанию\), базе данных, RADIUS или _syslog_.

---

**Примечание**

Записи деталей вызовов не предназначены для использования в сложных приложениях биллинга. Если вам требуется больше контроля над биллингом и отчетностью о вызовах - обратите внимание на журнал событий канала (CEL), обсуждаемый далее. Преимущество CDR заключается в том, что он просто работает.

---

Таблица 2-3. _Общие модули записи деталей вызова_

| Name | Purpose |
| :--- | :--- |
| cdr_adaptive_odbc | Allows writing of CDRs through ODBC framework with ability to add custom fields |
| cdr_csv | Writes CDRs to disk as a comma-separated values (CSV) file |
| cdr_custom | Writes CDRs to a CSV file, but allows addition of custom fields |
| cdr_odbc | Writes CDRs through ODBC framework |
| cdr_syslog | Writes CDRs to syslog |

### Модули логирования событий канала

Channel event logging (CEL) provides much more powerful control over reporting of call activity. By the same token, it requires more careful planning of your dialplan, and by no means will it work automatically. Asterisk’s CEL modules are listed in [Table 2-4](Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition/2.%20Asterisk%20Architecture%20-%20Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition.htm%22%20/l%20%22Architecture_id292113).

Таблица 2-4. _Модули логирования событий канала_

| Name | Purpose |
| :--- | :--- |
| cel\_custom | CEL to disk/file |
| cel\_manager | CEL to AMI |
| cel\_odbc | CEL to ODBC |

### Драйверы каналов

Без драйверов каналов у Asterisk не было бы возможности совершать или принимать вызовы. Каждый драйвер канала специфичен для протокола или типа канала, который он поддерживает \(SIP, ISDN и т.д.\). Модуль канала действует как шлюз к ядру Asterisk. Некоторые из наиболее популярных драйверов каналов Asterisk перечислены в Таблице 2-5.

Таблица 2-5. _Популярные драйверы каналов_

| Имя | Назначение |
| :--- | :--- |
| chan\_bridge | Используется внутри приложения `ConfBridge()`; не должен использоваться напрямую |
| chan\_dahdi | Обеспечивает подключение к картам ТфОП, использующим драйверы каналов DAHDI |
| chan\_local | Предоставляет механизм для обработки части диалплана как канала |
| chan\_motif | Реализует протокол Jingle, включая возможность подключения к Google Talk и Google Voice; представлен в Asterisk 11 |
| chan\_multicast\_rtp | Обеспечивает подключение к потокам многоадресного Realtime Transport Protocol \(RTP\) |
| chan\_pjsip | Драйвер канала Session Initiation Protocol \(SIP\) |

### Трансляторы кодеков

Трансляторы кодеков[3](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch02.html%22%20/l%20%22idm46178409283960) \(часто называемые транскодерами\) позволяют Asterisk конвертировать форматы аудиопотоков между вызовами. Поэтому, если вызов поступает по каналу PRI \(используя G.711\) и должен быть передан в сжатый канал SIP \(например, используя G.729, один из многих кодеков, которые может обрабатывать SIP\), соответствующий транслятор кодека выполнит преобразование.

Кодеки-это сложные алгоритмы, которые обрабатывают преобразование аналоговой информации \(в данном случае звука, но также может быть и видео\) в цифровой формат. Многие кодеки также обеспечивают сжатие и исправление ошибок, но это не является обязательным требованием.

---

**Примечание**

Если кодек (например G.729) использует сложный алгоритм кодирования, интенсивное использование транскодинга может создать огромную нагрузку на процессор. Специализированное оборудование для декодирования/кодирования G.729 доступно от производителей оборудования, таких как Sangoma и Digium (и, вероятно, других).

---

Asterisk делает довольно хорошую работу по поддержке кодеков, но в основном сосредоточен на кодеках, обычно используемых телефонными приложениями (в отличие от кодеков, используемых, скажем, для музыки или видео, таких как MP3 или MP4). Они перечислены в [Таблице 2-6](Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition/2.%20Asterisk%20Architecture%20-%20Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition.htm%22%20/l%20%22Architecture_id292600).

Таблица 2-6. _Общие трансляторы кодеков_

| Имя | Назначение |
| :--- | :--- |
| codec_alaw | Кодек PCM A-law используется во всем мире на ТфОП (кроме Канады/США). Этот кодек (вместе с ulaw) должен быть включен на всех ваших каналах. |
| codec_g729 | До недавнего времени это был запатентованный кодек, но теперь он является бесплатным. На момент написания этой статьи он по-прежнему продается Digium в качестве дополнения, но его также можно найти в виде бесплатного пакета. Это очень популярный кодек, если требуется сжатие \(и использование процессора не является проблемой\), но он накладывает нагрузку на процессор, добавляет задержку к вызовам, немного снижает качество и никоим образом не уменьшает накладные расходы. |
| codec\_a\_mu | Прямой конвертер A-law в mu-law. |
| codec\_g722 | Широкополосный аудиокодек. |
| codec\_gsm | Кодек Global System for Mobile Communications \(GSM\). Очень низкое качество звука. |
| codec\_ilbc | Интернет-кодек с низким битрейтом \(iLBC\). |
| codec\_lpc10 | Линейный предсказательный кодирующий вокодер \(чрезвычайно низкая пропускная способность\). |
| codec\_opus | Предназначен для замены speex \(и vorbis\). |
| codec\_resample | Пересемлирование между 8-ми и 16-тибитными линейными сигналами. |
| codec\_speex | Кодек Speex. |
| codec\_ulaw | Кодек PCM Mu-law, используемый на ТфОП в Канаде/США. Это более формально написано как μ-закон, но не у многих людей есть греческая буква μ на клавиатуре, поэтому обычно пишется как ulaw.a Часто является кодеком по умолчанию, и должен быть включен на всех ваших каналах. |
| | [a](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch02.html%22%20/l%20%22idm46178403326376-marker)Произносится как  “мью-лоу,” но так же вы часто будете слышать как "ю-лоу".|

---

**Совет**

Digium предоставляет некоторые дополнительные полезные модули кодеков: `codec_g729`,` codec_silk`, `codec_siren7` и `codec_siren14`. Эти модули кодеков не являются open source по различным причинам. Вы должны приобрести лицензию на использование `codec_g729`, но остальные являются бесплатными. Вы можете найти их на [сайте Digium](http://downloads.digium.com/pub/telephony/).

---

### Интерпретаторы формата

Интерпретаторы форматов ([Таблица 2-7](Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition/2.%20Asterisk%20Architecture%20-%20Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition.htm%22%20/l%20%22Architecture_id292825)) выполняют ту же функцию, что и переводчики кодеков, но они работают с файлами, а не с каналами, и обрабатывают не только аудио. Если у вас есть запись в меню, которое было сохранено как GSM, вам нужно будет использовать интерпретатор формата для воспроизведения этой записи на любые каналы, не использующие кодек GSM.[4](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch02.html%22%20/l%20%22idm46178403315272)

Таблица 2-7. _Интерпретаторы форматов_

| Name | Plays files stored in |
| :--- | :--- |
| format\_g729 | G.729: .*g729* |
| format\_gsm | RPE-LTP (оригинальный кодек GSM): .*gsm* |
| format\_h264 | H.264 video: .*h264* |
| format\_ilbc | Интернет кодек с низким битрейтом: .*ilbc*|
| format\_jpeg | Графический файл: .*jpeg*, .*jpg* |
| format \_ogg\_ vorbis | Ogg container: .*ogg* |
| format\_pcm | Различные форматы импульсно-кодированной модуляции: .*alaw*, .*al*, .*alw*, .*pcm*, .*ulaw*, .*ul*, .*mu*, .*ulw*, .*g722*, .*au* |
| format\_siren14 | G.722.1 Annex C \(14 kHz): .*siren14* |
| format\_siren7 | G.722.1 (7 kHz): .*siren7* |
| format\_sln | 8-bit signed linear: .*sln*, .*raw* |
| format\_vox | .*vox* |
| format\_wav | .*wav* |
| format\_wav\_gsm | GSM аудио в контейнере WAV: .*wav*, .*wav49* |

### Функции Диалплана

Функции диалплана, перечисленные в [Таблице 2-8](Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition/2.%20Asterisk%20Architecture%20-%20Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition.htm%22%20/l%20%22Architecture_id293094), дополняют приложения диалплана \(смотри [“Приложения”](Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition/2.%20Asterisk%20Architecture%20-%20Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition.htm%22%20/l%20%22Architecture_id241422)\). Они предоставляют множество полезных улучшений для таких вещей, как обработка строк, смещение времени и даты и подключение ODBC.

Таблица 2-8. _Утверждённый список полезных функций диалплана_

| Name | Purpose |
| :--- | :--- |
| func_audiohookin⁠herit | Позволяет записывать звонки после трансфера |
| func\_blacklist | Пишет / читает черный список в _astdb_ |
| func\_callcompletion | Получает / устанавливает параметры конфигурации завершения вызова для канала |
| func\_callerid | Получает / устанавливает идентификатор звонящего (Caller ID) |
| func\_cdr | Получает / устанавливает переменную CDR |
| func\_channel | Gets/sets channel information |
| func\_config | Включает `AST_CONFIG()`; считывает переменные из файла конфигурации |
| func\_curl |Использует cURL для получения данных из URI |
| func\_cut | Slices and dices strings |
| func\_db | Предоставляет функции _astdb_ |
| func\_devstate | Получает состояние устройства |
| func\_dialgroup |Создает группу для одновременного набора |
| func\_dialplan | Проверяет, что назначенная цель существует в диалплане |
| func\_env | Включает `FILE()`, `STAT()` и `ENV()`; выполняет действия операционной системы |
| func\_global | Получает / устанавливает глобальные переменные |
| func\_groupcount | Получает / устанавливает количество каналов для членов группы |
| func\_hangupcause | Получает / устанавливает информацию о зависании из канала |
| func\_logic | Включает `ISNULL()`, `SET()`, `EXISTS()`, `IF()`, `IFTIME()` и `IMPORT()`; выполняет различные логические функции |
| func\_math | Включает `MATH()`, `INC()` и `DEC()`; выполняет математические функции |
| func\_odbc | Позволяет интегрировать диалплан с ресурсами ODBC |
| func\_rand | Возвращает случайное число в заданном диапазоне |
| func\_realtime | Выполняет поиск в Asterisk Realtime Architecture (ARA) |
| func\_redirecting | Предоставляет доступ к информации о том, откуда был перенаправлен этот вызов |
| func\_shell | Выполняет операции оболочки Linux и возвращает результаты |
| func\_sprintf | Выполняет функции строкового формата, аналогичные функции C с тем же именем |
| func\_srv | Выполняет поиски SRV в диалплане |
| func\_strings | Включает в себя более десятка функций обработки строк |
| func\_timeout | Получает / устанавливает таймауты на канале |
| func\_uri | Преобразует строки в URI-безопасную кодировку |
| func\_vmcount | Возвращает количество сообщений в папке голосовой почты для определенного пользователя. |

### PBX Modules

Модули PBX это периферийные модули, которые обеспечивают улучшенные механизмы управления и настройки. Например, pbx\_config это модуль, который загружает традиционный диалплан Asterisk. Доступные в настоящее время модули PBX перечислены в [Таблице 2-9](Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition/2.%20Asterisk%20Architecture%20-%20Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition.htm%22%20/l%20%22Architecture_id293725).

Таблица 2-9. _PBX модули_

| Name | Purpose |
| :--- | :--- |
| pbx\_config | Этот модуль предоставляет традиционный, популярный язык плана набора для Asterisk. Без этого модуля Asterisk не может читать _extensions.conf_. |
| pbx\_dundi | Выполняет поиск данных в удаленных системах Asterisk. |
| pbx\_realtime | Предоставляет функциональные возможности, связанные с архитектурой Asterisk Realtime. |
| pbx\_spool | Обеспечивает поддержку исходящих сообщений, относящихся к файлам вызовов Asterisk. |

### Resource Modules

Resource modules integrate Asterisk with external resources. This group of modules has effectively turned into a catch-all for things that do not fit in other categories. We will break them into some subgroups of modules that are related.

#### Configuration backends

Asterisk настроен с использованием текстовых файлов _/etc/asterisk_ по умолчанию. Модули, перечисленные в [Таблице 2-10](Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition/2.%20Asterisk%20Architecture%20-%20Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition.htm%22%20/l%20%22Architecture_id2938860), предлагают альтернативные методы настройки. Смотри [Глава 15](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch15.html%22%20/l%20%22asterisk-DB) для получения подробной документации по настройке конфигурации на основе базы данных.

Таблица 2-10. _Конфигурационные бэкэнд-модули_

| Name | Purpose |
| :--- | :--- |
| res\_config\_curl | Получает информацию о конфигурации, используя cURL |
| res\_config\_ldap | Получает информацию о конфигурации, используя LDAP |
| res\_config\_odbc | Получает информацию о конфигурации, используя ODBC |

#### Интеграция календаря

Asterisk включает некоторую интеграцию с календарными системами. Вы можете читать и записывать информацию календаря из плана набора. Вы также можете иметь звонки на основе записей календаря. Основная интеграция календаря обеспечивается модулем `res_calendar`. Остальные модули предоставляют возможность подключения к определенным типам календарных серверов. [Таблица 2-11](Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition/2.%20Asterisk%20Architecture%20-%20Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition.htm%22%20/l%20%22Architecture_id2938862) перечисляет модули интеграции календаря.

Таблица 2-11. _Модули интеграции календаря_

| Name | Purpose |
| :--- | :--- |
| res\_calendar | Обеспечивает базовую интеграцию с календарными системами |
| res\_calendar\_caldav | Позволяет функциям, предоставляемым `res_calendar`, подключаться к календарям через CalDAV |
| res\_calendar\_exchange | Позволяет функциям, предоставляемым `res_calendar`, подключаться к MS Exchange |
| res\_calendar\_icalendar | Позволяет функциям, предоставляемым `res_calendar`, подключаться к Apple/Google iCalendar |

#### Другие ресурсные модули

[Таблица 2-12](Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition/2.%20Asterisk%20Architecture%20-%20Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition.htm%22%20/l%20%22Architecture_id293886) включает остальные модули ресурсов, которые не вписываются в одну из подгрупп, которые мы определили ранее в этом разделе.

Таблица 2-12. _Ресурсные модули_

<table>
  <thead>
    <tr>
      <th style="text-align:left">Name</th>
      <th style="text-align:left">Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align:left">res_adsi</td>
      <td style="text-align:left">Предоставляет ADSI<a href="https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch02.html%22%20/l%20%22idm46178409429112">a</a>
      </td>
    </tr>
    <tr>
      <td style="text-align:left">res_agi</td>
      <td style="text-align:left">Предоставляет интерфейс Asterisk Gateway (смотри <a href="https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch18.html%22%20/l%20%22AGI">Глава 18</a>)</td>
    </tr>
    <tr>
      <td style="text-align:left">res_corosync</td>
      <td style="text-align:left">Предоставляет распределенную индикацию ожидания сообщения (MWI) и состояние устройства уведомления через Corosync Cluster Engine</td>
    </tr>
    <tr>
      <td style="text-align:left">res_crypto</td>
      <td style="text-align:left">Предоставляет криптографические возможности</td>
    </tr>
    <tr>
      <td style="text-align:left">res_curl</td>
      <td style="text-align:left">Предоставляет общие подпрограммы для других модулей cURL</td>
    </tr>
    <tr>
      <td style="text-align:left">res_fax</td>
      <td style="text-align:left">Предоставляет общие подпрограммы для других факсимильных модулей</td>
    </tr>
    <tr>
      <td style="text-align:left">res_fax_spandsp</td>
      <td style="text-align:left">Плагин для факса с использованием пакета  spandsp </td>
    </tr>
    <tr>
      <td style="text-align:left">res_http_post</td>
      <td style="text-align:left">Обеспечивает поддержку загрузки POST для HTTP-сервера Asterisk</td>
    </tr>
    <tr>
      <td style="text-align:left">res_http_websocket</td>
      <td style="text-align:left">Обеспечивает поддержку WebSocket для внутреннего HTTP-сервера Asterisk (обязателен для WebRTC) </td>
    </tr>
    <tr>
      <td style="text-align:left">res_monitor</td>
      <td style="text-align:left">Предоставляет ресурсы записи разговоров</td>
    </tr>
    <tr>
      <td style="text-align:left">res_musiconhold</td>
      <td style="text-align:left">Предоставляет ресурсы музыки на удержании (MOH)</td>
    </tr>
    <tr>
      <td style="text-align:left">res_mutestream</td>
      <td style="text-align:left">Позволяет приглушать / отключать звуковые потоки</td>
    </tr>
    <tr>
      <td style="text-align:left">res_odbc</td>
      <td style="text-align:left">Предоставляет общие подпрограммы для других модулей ODBC</td>
    </tr>
    <tr>
      <td style="text-align:left">res_phoneprov</td>
      <td style="text-align:left">Предоставляет Автоматическую настройку телефонов с HTTP сервера Asterisk</td>
    </tr>
    <tr>
      <td style="text-align:left">res_pktccops</td>
      <td style="text-align:left">Предоставляет ресурсы PacketCable COPS</td>
    </tr>
    <tr>
      <td style="text-align:left">res_security_log</td>
      <td style="text-align:left">Включает ведение журнала событий безопасности, генерируемых другими частями Asterisk.</td>
    </tr>
    <tr>
      <td style="text-align:left">res_snmp</td>
      <td style="text-align:left">Предоставляет информацию о состоянии системы в сеть, управляемую SNMP</td>
    </tr>
    <tr>
      <td style="text-align:left">res_speech</td>
      <td style="text-align:left">Общий API распознавания речи<a href="https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch02.html%22%20/l%20%22idm46178409412232">b</a>
      </td>
    </tr>
    <tr>
      <td style="text-align:left">res_stasis</td>
      <td style="text-align:left">Связывает вместе различные компоненты инфраструктуры приложения Stasis</td>
    </tr>
    <tr>
      <td style="text-align:left">res_xmpp</td>
      <td style="text-align:left">Предоставляет ресурсы XMPP (FKA Jabber)</td>
    </tr>
    <tr>
      <td style="text-align:left">
        <p><a href="https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch02.html%22%20/l%20%22idm46178409429112-marker">a</a> В то время как
          большинство функций ADSI в Asterisk никогда не используется, приложение голосовая почта
          использует этот ресурс.</p>
      <td style="text-align:left"><a href="https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch02.html%22%20/l%20%22idm46178409412232-marker">b</a> требует
           отдельно лицензированный продукт для использования.</p>
      </td>
      <td style="text-align:left"></td>
    </tr>
  </tbody>
</table>### Дополнительные модули

Дополнительные модули - это разработанные сообществом модули с правами на использование или распространение, отличными от основных кодов. ([Таблица 2-13](Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition/2.%20Asterisk%20Architecture%20-%20Asterisk%20%20The%20Definitive%20Guide,%205th%20Edition.htm%22%20/l%20%22Architecture_id294470)\). Они хранятся в отдельном каталоге и не компилируются и не устанавливаются по умолчанию. Чтобы включить эти модули, используйте утилиту настройки сборки `menuselect` .

Таблица 2-13. _Дополнительные модули_

| Name | Purpose | Popularity/status |
| :--- | :--- | :--- |
| chan\_ooh323 | Позволяет совершать и принимать звонки VoIP по протоколу H.323. | Usable |
| format\_mp3 | Позволяет Asterisk воспроизводить файлы MP3 | Usable |
| res\_config\_mysql | Использует базу данных MySQL как сервер конфигурации в режиме реального времени | Useful |

### Тестовые модули

Тестовые модули используются командой разработчиков Asterisk для проверки нового кода. Они постоянно меняются и добавляются, и не являются полезными, если вы не разрабатываете программное обеспечение Asterisk.

Однако если вы являетесь разработчиком Asterisk, то набор тестов Asterisk может представлять для вас интерес, поскольку вы можете создавать автоматизированные тесты для Asterisk и отправлять их обратно в проект, который работает на нескольких различных операционных системах и типах машин. Постоянно расширяя число тестов, проект Asterisk позволяет избежать создания регрессий в коде. Отправляя свои собственные тесты в проект, вы можете чувствовать себя более уверенно в будущих обновлениях.

Дополнительные сведения о построении тестов доступны в документе ["The Asterisk Test Suite"](http://bit.ly/14SLEqs), или вы можете присоединиться к каналу тестирования `#asterisk-testing` в IRC-сети Freenode.

## Файловая структура

Asterisk - сложная система, состоящая из множества ресурсов. Эти ресурсы используют файловую систему несколькими способами. Поскольку Linux очень гибок в этом отношении, полезно понять, какие данные хранятся, чтобы вы могли понять, где вы можете найти определенный бит хранимых данных (например, сообщения голосовой почты или файлы журналов).

### Конфигурационные файлы

Конфигурационные файлы Asterisk включают в себя _extensions.conf_, _pjsip.conf_, _modules.conf_ и десятки других файлов, которые определяют параметры для различных каналов, ресурсов, модулей и функций, которые могут использоваться.

Эти файлы обычно находятся в _/etc/asterisk_ . Вы будете много работать в этой папке, когда будете настраивать и администрировать свою систему Asterisk.

### Модули

Модули Asterisk обычно устанавливаются в папку _/usr/lib/asterisk/modules_. Вам обычно не придется взаимодействовать с этой папкой; однако иногда полезно знать, где находятся модули. Например, если вы обновите Asterisk и выберете разные модули во время фазы выбора меню установки, старые (несовместимые) модули из предыдущей версии Asterisk не будут удалены, и вы получите предупреждение из сценария установки. Эти старые файлы необходимо удалить из папки модулей. Это можно сделать вручную или с помощью целевого объекта «uninstall» make  (`make uninstall`).

### Библиотека ресурсов

Есть несколько ресурсов, которые требуют внешних источников данных. Например, музыка в ожидании (MOH) не может произойти, если у вас нет музыки для воспроизведения. Системные подсказки также должны храниться где-то на жестком диске. В папке _/var/lib/asterisk_ хранятся системные подсказки, сценарии AGI, музыка в ожидании и другие файлы ресурсов.

### Спул

Спул - это место, где приложения хранят файлы в системе Linux, которые будут часто меняться или которые будут обрабатываться другими процессами позднее. Например, задания на печать в Linux и ожидающие сообщения электронной почты обычно записываются в спул, пока они не будут обработаны.

В Asterisk спул используется для хранения временных элементов, таких как голосовые сообщения, записи вызовов,[6](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch02.html%22%20/l%20%22idm46178409226312) файлы вызовов и так далее.

Спул Asterisk находится в каталоге _/var/spool/asterisk_ .

### Логирование

Asterisk может генерировать несколько разных типов лог-файлов. Папка _/var/log/asterisk_ - это место, где записываются подробные записи вызовов (CDRы), события канала из CEL, журналы отладки, журналы очереди, сообщения, ошибки и другие выходные данные.

Эта папка будет чрезвычайно важна для любых предпринимаемых вами действий по устранению неполадок. Мы поговорим подробнее о том, как использовать логи Asterisk в [Главе 21](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch21.html%22%20/l%20%22asterisk-Monitoring).

## Диалплан

Диалплан - это сердце Asterisk. Все каналы, поступающие в систему, будут проходить через план набора, который содержит сценарии потока вызовов, определяющие, как обрабатываются входящие вызовы.

Абонентская группа обычно пишется с использованием собственного синтаксиса диалплана Asterisk, который хранится в файле с именем _/etc/asterisk/extensions.conf_ . Есть и другие способы управления потоком вызовов, и мы рассмотрим их позже, но независимо от того, какой метод вы в конечном итоге используете, вы обнаружите, что базовое понимание традиционного диалплана будет чрезвычайно полезно. Именно на этом мы сосредоточимся в течение большей части первых двух третей этой книги.

Позже мы рассмотрим обработку потока вызовов вне диалплана, используя такие технологии, как AMI, AGI и ARI.

## Аппаратные средства

Asterisk способен общаться с огромным количеством различных технологий. Как правило, эти соединения выполняются через сетевое соединение TCP/IP (обычно с использованием SIP). Однако подключения к более традиционным телекоммуникационным каналам, таким как PRI (T1, E1 и т. Д.), BRI (EuroISDN) SS7 (в основном, T1 и E1), и аналоговым (все, от нескольких портов FXO и FXS до крупных каналов каналов, питаются через соединения T1/E1 CAS/RBS), также может быть достигнуто с помощью физических карт, установленных на сервере.

Многие компании производят это оборудование, такие как Digium (спонсор, владелец и основной разработчик Asterisk), Sangoma (который недавно приобрел Digium), Dialogic (также компания Sangoma), OpenVox, Pika, Voicetronix, beroNet и многие другие. Все эти компании были связаны с Asterisk на протяжении многих лет.

Наиболее популярное оборудование для Asterisk, как правило, предназначено для работы через интерфейс аппаратного устройства Digium Asterisk (известный как DAHDI). Это сложная архитектура, и она выходит за рамки этой книги. Все серверные телефонные карты будут иметь требования к установке, уникальные для производителя, и вам потребуются сильные навыки в установке оборудования Linux, а также в устранении неисправностей и подготовке традиционных сетей PSTN.

Если вам необходимо взаимодействовать с традиционными цепями PSTN с использованием Asterisk, мы рекомендуем вам сохранить Asterisk в качестве платформы только для SIP и взаимодействовать с помощью стороннего шлюза какого-либо рода. Имейте в виду: это не материал начального уровня, и если вы только начинаете использовать Asterisk, вам настоятельно рекомендуется оставить свои первоначальные решения только для SIP.

## Версии Asterisk

Методология выпуска Asterisk прошла через несколько стилей. В прошлом это приводило к некоторой путанице, но в наши дни управление версиями довольно простое и относительно простое для понимания. Digium сохранил отличную ссылку на [Asterisk wiki](http://bit.ly/2XTb5Wl) , и мы призываем вас перейти на последние подробности о версиях Asterisk.

Эта книга была написана и протестирована с использованием версии 16, но вы обнаружите, что фундаментальные концепции, которые мы исследуем, будут актуальны для большинства версий Asterisk. Концептуальная структура Asterisk не менялась в течение достаточно долгого времени, и на момент написания этой статьи не было никаких известных планов изменить это в будущем. Будущие версии предоставят более мощные возможности мультимедиа и конференц-связи, но они, вероятно, будут реализованы в рамках существующей структуры.

## Вывод

Asterisk состоит из множества различных технологий, большинство из которых сложны сами по себе. В результате понимание архитектуры Asterisk может быть ошеломляющим. Тем не менее, реальность такова, что Asterisk хорошо спроектирован для того, что он делает, и, по нашему мнению, достиг замечательного баланса между гибкостью и сложностью.

[1](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch02.html%22%20/l%20%22idm46178408963912-marker) Хорошим показателем того, что вы работали с традиционными АТС, является наличие большой мозоли на лбу, полученной от удара головой о кирпичную стену слишком много раз

[2](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch02.html%22%20/l%20%22idm46178409833272-marker) Эта команда доступна как часть процесса установки. Мы обсудим использование `menuselect` и в главе "установка Asterisk".

[3](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch02.html%22%20/l%20%22idm46178409283960-marker) Перевести вGoogleBingТермин кодек сокращенно означает "кодер-декодер". Термин кодек сокращенно означает "кодер-декодер".”

[4](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch02.html%22%20/l%20%22idm46178403315272-marker) Отчасти по этой причине мы не рекомендуем формат GSM по умолчанию для системных записей. WAV-записи будут звучать лучше и использовать меньше тактов процессора.

[5](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch02.html%22%20/l%20%22idm46178403313864-marker) Некоторые кодеки создают значительную нагрузку на ЦП, настолько, что система, которая может поддерживать несколько сотен каналов без транскодирования, будет обрабатывать только несколько десятков, когда транскодирование используется.

[6](https://learning.oreilly.com/library/view/asterisk-the-definitive/9781492031598/ch02.html%22%20/l%20%22idm46178409226312-marker) Не подробные записи вызовов (CDR), а аудиозаписи вызовов, сгенерированных `MixMonitor()` и соответствующими приложениями.

[Глава 1. Революция в телефонии](glava-01.md) | [Содержание](SUMMARY.md)  | [Глава 3. Установка Asterisk](glava-03.md)
